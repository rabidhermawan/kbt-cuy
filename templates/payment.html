<!DOCTYPE html>
<html>
<head>
    <title>Scan to Pay</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Midtrans Snap.js -->
    <script src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="{{ .ClientKey }}"></script>
</head>
<body>
    {{ template "navbar" . }}
    <div class="container mt-5" style="max-width: 500px;">
        <div class="card shadow">
            <div class="card-header bg-primary text-white text-center">
                <h4>Complete Your Payment</h4>
            </div>
            <div class="card-body text-center">
                <p>You are renting from: <strong>{{ .Station.Name }}</strong></p>
                <h2 class="text-center my-4">Rp 10.000 <small class="text-muted fs-6">/ 24 hours</small></h2>

                <p>Click the button below to complete your payment securely.</p>
                <div id="snap-container"></div>
                <button id="pay-button" class="btn btn-primary w-100 btn-lg mt-3">Pay Now (Rp 10.000)</button>
                <div id="payment-status" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        document.getElementById('pay-button').onclick = function(){
            const stationId = "{{ .Station.ID }}";
            const statusElement = document.getElementById('payment-status');
            const payButton = document.getElementById('pay-button');

            payButton.disabled = true;
            statusElement.innerHTML = `<div class="spinner-border text-primary" role="status"></div><p>Generating payment...</p>`;

            fetch('/payment/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `station_id=${stationId}`
            })
            .then(res => res.json())
            .then(data => {
                payButton.disabled = false;
                statusElement.innerHTML = '';

                if (data.error) {
                    statusElement.innerHTML = `<div class="alert alert-danger">${data.error}: ${data.details || ''}</div>`;
                    return;
                }
                
                window.snap.pay(data.token, {
                    onSuccess: function(result){
                       statusElement.innerHTML = `<div class="alert alert-success">Payment successful! Processing your rental, please wait...</div>`;

                       // Poll the backend to know when the rental is fully processed
                       const pollInterval = setInterval(() => {
                           fetch(`/payment/status/${data.transaction_id}`)
                               .then(res => res.json())
                               .then(statusData => {
                                   if (statusData.status === 'success') {
                                       clearInterval(pollInterval);
                                       window.location.href = `/rental/success/${statusData.transaction_id}`;
                                   } else if (statusData.status === 'failed') {
                                       clearInterval(pollInterval);
                                       statusElement.innerHTML = `<div class="alert alert-danger">Rental processing failed. Please contact support.</div>`;
                                   }
                                   // Otherwise, just keep polling (status is 'pending')
                               })
                               .catch(err => {
                                   clearInterval(pollInterval);
                                   statusElement.innerHTML = `<div class="alert alert-danger">Error checking status. Please refresh.</div>`;
                               });
                       }, 1500); // Check every 1.5 seconds
                   },
                    onPending: function(result){
                        statusElement.innerHTML = `<div class="alert alert-info">Waiting for your payment...</div>`;
                    },
                    onError: function(result){
                         statusElement.innerHTML = `<div class="alert alert-danger">Payment failed. Please try again.</div>`;
                    },
                    onClose: function(){
                        statusElement.innerHTML = `<div class="alert alert-warning">Payment pop-up closed.</div>`;
                    }
                });
            })
            .catch(err => {
                payButton.disabled = false;
                statusElement.innerHTML = `<div class="alert alert-danger">An error occurred. Please refresh and try again.</div>`;
            });
        };
    </script>
</body>
</html>